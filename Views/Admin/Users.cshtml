@{
    ViewData["Title"] = "Quản lý Người dùng";
}

@section Styles {
    <link rel="stylesheet" href="~/Views/Admin/Dashboard.cshtml.css" />
}

<admin-users></admin-users>

@section Templates {
    <script type="text/x-template" id="admin-users-template">
        <div class="admin-bg flex">
            <!-- Sidebar (Same as Dashboard) -->
            <div class="w-64 bg-white shadow-md min-h-screen hidden lg:block fixed left-0 top-16 bottom-0 overflow-y-auto z-10">
                <div class="p-6">
                    <h2 class="text-xs uppercase text-gray-400 font-bold tracking-wider mb-4">Quản lý</h2>
                    <nav class="space-y-1">
                        <a href="/Admin/Dashboard" class="sidebar-link flex items-center px-4 py-3 text-gray-600 rounded-lg font-medium">
                            <i class="ph-bold ph-squares-four text-xl mr-3"></i> Dashboard
                        </a>
                        <a href="/Admin/Orders" class="sidebar-link flex items-center px-4 py-3 text-gray-600 rounded-lg font-medium">
                            <i class="ph-bold ph-shopping-cart text-xl mr-3"></i> Đơn hàng
                        </a>
                        <a href="/Admin/Food" class="sidebar-link flex items-center px-4 py-3 text-gray-600 rounded-lg font-medium">
                            <i class="ph-bold ph-hamburger text-xl mr-3"></i> Món ăn
                        </a>
                        <a href="/Admin/Combos" class="sidebar-link flex items-center px-4 py-3 text-gray-600 rounded-lg font-medium">
                            <i class="ph-bold ph-package text-xl mr-3"></i> Combo
                        </a>
                        <a href="/Admin/Users" class="sidebar-link active flex items-center px-4 py-3 text-gray-600 rounded-lg font-medium">
                            <i class="ph-bold ph-users text-xl mr-3"></i> Người dùng
                        </a>
                    </nav>
                </div>
            </div>

            <div class="flex-1 lg:ml-64 p-8">
                <div class="mb-8 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Danh sách người dùng</h1>
                    <div class="relative w-64">
                        <input v-model="searchQuery" type="text" class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Tìm kiếm...">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="ph-bold ph-magnifying-glass text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 font-medium">
                            <tr>
                                <th class="px-6 py-3">ID</th>
                                <th class="px-6 py-3">Họ tên</th>
                                <th class="px-6 py-3">Email</th>
                                <th class="px-6 py-3">SĐT</th>
                                <th class="px-6 py-3">Vai trò</th>
                                <th class="px-6 py-3 text-right">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-for="user in filteredUsers" :key="user.userId" class="table-row-hover">
                                <td class="px-6 py-4">#{{ user.userId }}</td>
                                <td class="px-6 py-4 font-medium text-gray-900">{{ user.lastName }} {{ user.firstName }}</td>
                                <td class="px-6 py-4">{{ user.email }}</td>
                                <td class="px-6 py-4">{{ user.phone }}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold uppercase"
                                          :class="user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'">
                                        {{ user.role }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button v-on:click="deleteUser(user.userId)" class="text-red-500 hover:text-red-700 p-1">
                                        <i class="ph-bold ph-trash text-lg"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </script>
}

@section Scripts {
    <script>
        const serverUsers = @Html.Raw(Json.Serialize(Model));

        if (window.vueApp) {
            window.vueApp.component('admin-users', {
                template: '#admin-users-template',
                setup() {
                    const { ref, computed } = Vue;
                    const users = ref(serverUsers);
                    const searchQuery = ref('');

                    const filteredUsers = computed(() => {
                        if (!searchQuery.value) return users.value;
                        const q = searchQuery.value.toLowerCase();
                        return users.value.filter(u => 
                            (u.email && u.email.toLowerCase().includes(q)) || 
                            (u.phone && u.phone.includes(q)) ||
                            ((u.firstName + ' ' + u.lastName).toLowerCase().includes(q))
                        );
                    });

                    const deleteUser = async (id) => {
                        if (!confirm('Bạn có chắc chắn muốn xóa người dùng này?')) return;
                        
                        try {
                            const res = await fetch(`/Admin/DeleteUser/${id}`, { method: 'POST' });
                            const data = await res.json();
                            if (data.success) {
                                users.value = users.value.filter(u => u.userId !== id);
                                if(window.showNotification) window.showNotification("Đã xóa người dùng", "success");
                            } else {
                                if(window.showNotification) window.showNotification(data.message, "error");
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    };

                    return { users, searchQuery, filteredUsers, deleteUser };
                }
            });
        }
    </script>
}
