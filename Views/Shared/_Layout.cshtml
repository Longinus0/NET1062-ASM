@using System.Security.Claims
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - FastFood App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@@phosphor-icons/web"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .nav-link { position: relative; }
        .nav-link::after {
            content: ''; position: absolute; width: 0; height: 2px;
            bottom: -2px; left: 0; background-color: #f97316;
            transition: width 0.3s ease-in-out;
        }
        .nav-link:hover::after { width: 100%; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        [v-cloak] { display: none; }
    </style>

    @await RenderSectionAsync("Styles", required: false)
</head>
<body class="bg-gray-50">
    @{
        var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
        var userName = User.FindFirst(ClaimTypes.Name)?.Value ?? "Khách";
        var userRole = User.FindFirst(ClaimTypes.Role)?.Value ?? "guest";
        
        // 1. Try to get Avatar from Claims
        var avatar = User.FindFirst("Avatar")?.Value;

        // 2. Fallback: If empty, use UI Avatars with Initials
        if (string.IsNullOrEmpty(avatar))
        {
            avatar = $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(userName)}&background=f97316&color=fff";
        }
    }

    <script>
        window.serverState = {
            isAuthenticated: @Json.Serialize(isAuthenticated),
            userName: @Json.Serialize(userName),
            role: @Json.Serialize(userRole),
            avatar: @Json.Serialize(avatar)
        };

        window.requireLogin = function() {
            if (!window.serverState.isAuthenticated) {
                if (window.showNotification) {
                    window.showNotification("Vui lòng đăng nhập để thực hiện chức năng này!", "warning");
                } else {
                    alert("Vui lòng đăng nhập!"); 
                }
                setTimeout(() => { window.location.href = "/Account/Login"; }, 1500);
                return false;
            }
            return true;
        };
    </script>

    <div id="app" class="min-h-screen flex flex-col font-sans" v-cloak>
        <nav class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <!-- LEFT: Logo -->
                    <div class="flex items-center">
                        <a href="/" class="flex-shrink-0 flex items-center gap-2 group">
                            <i class="ph-fill ph-hamburger text-orange-500 text-3xl group-hover:scale-110 transition-transform"></i>
                            <span class="font-extrabold text-2xl tracking-tight text-gray-800">
                                Fast<span class="text-orange-500">Food</span>
                            </span>
                        </a>

                        <!-- CENTER: Desktop Links -->
                        <div class="hidden md:ml-10 md:flex md:space-x-8" v-if="currentUser.role !== 'admin'">
                            <a href="/Home/Index" class="nav-link text-gray-600 hover:text-orange-600 px-1 py-2 text-sm font-medium">Trang chủ</a>
                            <a href="/Home/Menu" class="nav-link text-gray-600 hover:text-orange-600 px-1 py-2 text-sm font-medium">Thực đơn</a>
                            <a href="/Home/Combo" class="nav-link text-gray-600 hover:text-orange-600 px-1 py-2 text-sm font-medium">Combo</a>
                        </div>
                        
                        <!-- ADMIN LINKS -->
                        <div class="hidden md:ml-10 md:flex md:space-x-8" v-if="currentUser.role === 'admin'">
                            <a href="/Admin/Dashboard" class="nav-link text-gray-600 hover:text-orange-600 px-1 py-2 text-sm font-medium">Dashboard</a>
                            <a href="/Admin/Orders" class="nav-link text-gray-600 hover:text-orange-600 px-1 py-2 text-sm font-medium">Đơn hàng</a>
                        </div>
                    </div>

                    <!-- RIGHT: Auth & Actions -->
                    <div class="flex items-center">
                        
                        <!-- GUEST -->
                        <template v-if="!currentUser.isAuthenticated">
                            <div class="hidden md:flex items-center space-x-3">
                                <a href="/Account/Login" class="text-gray-600 hover:text-orange-600 font-medium text-sm px-3 py-2">Đăng nhập</a>
                                <a href="/Account/Register" class="bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold px-4 py-2 rounded-full shadow-md transition-all">Đăng ký</a>
                            </div>
                        </template>

                        <!-- LOGGED IN -->
                        <template v-else>
                            <a href="/Cart" class="relative mr-5 cursor-pointer group" v-if="currentUser.role === 'customer'">
                                <div class="p-2 rounded-full group-hover:bg-orange-50 transition-colors">
                                    <i class="ph-bold ph-shopping-cart text-2xl text-gray-600 group-hover:text-orange-600"></i>
                                </div>
                                <span class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white">3</span>
                            </a>

                            <div class="relative ml-2" v-on:mouseenter="isProfileMenuOpen = true" v-on:mouseleave="isProfileMenuOpen = false">
                                <div class="flex items-center cursor-pointer space-x-2 py-2">
                                    <div class="hidden lg:block text-right leading-tight">
                                        <div class="text-sm font-bold text-gray-700">{{ currentUser.userName }}</div>
                                        <div class="text-xs text-green-600 uppercase">{{ currentUser.role }}</div>
                                    </div>
                                    <!-- Use dynamic avatar -->
                                    <img :src="currentUser.avatar" class="h-9 w-9 rounded-full border-2 border-orange-100 bg-gray-200 object-cover" alt="Avatar">
                                </div>
                                
                                <transition name="fade">
                                    <div v-if="isProfileMenuOpen" class="absolute right-0 mt-0 w-48 bg-white rounded-lg shadow-xl border border-gray-100 py-2 z-50 origin-top-right">
                                        <a href="/Account/Profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600">
                                            <i class="ph-bold ph-user mr-2"></i> Hồ sơ
                                        </a>
                                        <a href="/Account/Orders" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600" v-if="currentUser.role === 'customer'">
                                            <i class="ph-bold ph-receipt mr-2"></i> Đơn mua
                                        </a>
                                        <div class="border-t border-gray-100 my-1"></div>
                                        <a href="/Account/Logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 font-medium">
                                            <i class="ph-bold ph-sign-out mr-2"></i> Đăng xuất
                                        </a>
                                    </div>
                                </transition>
                            </div>
                        </template>

                        <!-- Mobile Menu Btn -->
                        <div class="flex md:hidden ml-4">
                            <button v-on:click="mobileMenuOpen = !mobileMenuOpen" class="text-gray-600 hover:text-orange-600 focus:outline-none p-2">
                                <i class="ph-bold text-2xl" :class="mobileMenuOpen ? 'ph-x' : 'ph-list'"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div v-show="mobileMenuOpen" class="md:hidden bg-white border-t border-gray-100 shadow-inner">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <template v-if="currentUser.role !== 'admin'">
                        <a href="/Home/Index" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50">Trang chủ</a>
                        <a href="/Home/Menu" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50">Thực đơn</a>
                    </template>
                    <div class="border-t border-gray-200 my-2"></div>
                    <template v-if="!currentUser.isAuthenticated">
                        <a href="/Account/Login" class="block w-full text-center px-4 py-2 mb-2 border border-orange-500 text-orange-600 font-medium rounded-md">Đăng nhập</a>
                        <a href="/Account/Register" class="block w-full text-center px-4 py-2 bg-orange-500 text-white font-bold rounded-md">Đăng ký</a>
                    </template>
                    <template v-else>
                        <a href="/Account/Logout" class="block px-3 py-2 text-red-600 font-medium hover:bg-red-50">Đăng xuất</a>
                    </template>
                </div>
            </div>
        </nav>

        @await Html.PartialAsync("_Notification")

        <main class="flex-grow">
            @RenderBody()
        </main>

        <footer class="bg-gray-800 text-white py-6 text-center text-sm">
            &copy; 2024 FastFood App
        </footer>
    </div>

    @await RenderSectionAsync("Templates", required: false)

    <!-- INITIALIZE VUE WITH SERVER DATA -->
    <script>
        const { createApp, ref, reactive } = Vue;
        
        const app = createApp({
            setup() {
                const currentUser = reactive(window.serverState || { 
                    isAuthenticated: false, 
                    userName: 'Khách', 
                    role: 'guest',
                    avatar: '' 
                });
                
                const mobileMenuOpen = ref(false);
                const isProfileMenuOpen = ref(false);

                return { 
                    currentUser, 
                    mobileMenuOpen, 
                    isProfileMenuOpen 
                };
            }
        });

        window.vueApp = app;
    </script>

    @await RenderSectionAsync("Scripts", required: false)

    <script>
        window.vueApp.mount('#app');
    </script>
</body>
</html>

