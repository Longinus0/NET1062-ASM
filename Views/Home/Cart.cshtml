@{
    ViewData["Title"] = "Giỏ hàng";
}

<cart-page></cart-page>

@section Templates {
    <script type="text/x-template" id="cart-template">
        <div class="min-h-screen bg-gray-50 py-12">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-8">Giỏ hàng của bạn</h1>

                <div v-if="cartItems.length === 0" class="text-center py-20 bg-white rounded-xl shadow-sm">
                    <i class="ph-duotone ph-shopping-cart text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">Giỏ hàng đang trống.</p>
                    <a href="/Home/Menu" class="mt-4 inline-block text-orange-600 font-medium hover:underline">Tiếp tục mua sắm</a>
                </div>

                <div v-else class="flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-2/3">
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <div v-for="(item, index) in cartItems" :key="index" class="p-4 flex items-center border-b border-gray-100 last:border-0">
                                <img :src="item.image" class="w-20 h-20 object-cover rounded-lg bg-gray-100" />
                                <div class="ml-4 flex-1">
                                    <h3 class="font-bold text-gray-900">{{ item.name }}</h3>
                                    <p class="text-sm text-gray-500">{{ formatPrice(item.price) }}</p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button v-on:click="updateQty(index, -1)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">-</button>
                                    <span class="font-medium w-4 text-center">{{ item.quantity }}</span>
                                    <button v-on:click="updateQty(index, 1)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">+</button>
                                </div>
                                <button v-on:click="removeItem(index)" class="ml-4 text-red-500 hover:text-red-700">
                                    <i class="ph-bold ph-trash text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:w-1/3">
                        <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Thanh toán</h3>
                            
                            <!-- Guest Info (If not logged in) -->
                            <div v-if="!currentUser.isAuthenticated" class="space-y-3 mb-4 border-b border-gray-100 pb-4">
                                <input v-model="checkoutForm.guestName" type="text" class="w-full p-2 border rounded" placeholder="Họ và tên" />
                                <input v-model="checkoutForm.guestPhone" type="text" class="w-full p-2 border rounded" placeholder="Số điện thoại" />
                            </div>

                            <div class="space-y-3 mb-6">
                                <input v-model="checkoutForm.address" type="text" class="w-full p-2 border rounded" placeholder="Địa chỉ giao hàng" />
                                <textarea v-model="checkoutForm.note" class="w-full p-2 border rounded" placeholder="Ghi chú (tùy chọn)"></textarea>
                                <select v-model="checkoutForm.paymentMethod" class="w-full p-2 border rounded">
                                    <option value="cod">Thanh toán khi nhận hàng (COD)</option>
                                    <option value="momo">Ví MoMo</option>
                                    <option value="bank_card">Thẻ ngân hàng</option>
                                </select>
                            </div>

                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Tạm tính</span>
                                <span class="font-bold">{{ formatPrice(total) }}</span>
                            </div>
                            <div class="flex justify-between items-center mb-6">
                                <span class="text-gray-600">Phí giao hàng</span>
                                <span class="font-bold">0 ₫</span>
                            </div>
                            <div class="flex justify-between items-center mb-6 pt-4 border-t border-gray-100">
                                <span class="text-lg font-bold">Tổng cộng</span>
                                <span class="text-xl font-extrabold text-orange-600">{{ formatPrice(total) }}</span>
                            </div>

                            <button v-on:click="checkout" :disabled="isLoading" class="w-full py-3 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 disabled:opacity-50">
                                {{ isLoading ? 'Đang xử lý...' : 'Đặt hàng' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>
}

@section Scripts {
    <script>
        if (window.vueApp) {
            window.vueApp.component('cart-page', {
                template: '#cart-template',
                setup() {
                    const { ref, computed, onMounted, reactive } = Vue;
                    const cartItems = ref([]);
                    const isLoading = ref(false);
                    const currentUser = reactive(window.serverState);

                    const checkoutForm = reactive({
                        guestName: '', guestPhone: '', address: '', paymentMethod: 'cod', note: ''
                    });

                    onMounted(() => {
                        // Load cart from localStorage
                        const stored = localStorage.getItem('fastfood_cart');
                        if (stored) cartItems.value = JSON.parse(stored);
                    });

                    const updateQty = (index, delta) => {
                        const item = cartItems.value[index];
                        item.quantity += delta;
                        if (item.quantity <= 0) cartItems.value.splice(index, 1);
                        saveCart();
                    };

                    const removeItem = (index) => {
                        cartItems.value.splice(index, 1);
                        saveCart();
                    };

                    const saveCart = () => localStorage.setItem('fastfood_cart', JSON.stringify(cartItems.value));

                    const total = computed(() => cartItems.value.reduce((sum, item) => sum + (item.price * item.quantity), 0));

                    const formatPrice = (p) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p);

                    const checkout = async () => {
                        if (!currentUser.isAuthenticated && (!checkoutForm.guestName || !checkoutForm.guestPhone)) {
                            return window.showNotification("Vui lòng nhập tên và SĐT", "error");
                        }
                        if (!checkoutForm.address) return window.showNotification("Vui lòng nhập địa chỉ", "error");

                        isLoading.value = true;
                        try {
                            const payload = {
                                ...checkoutForm,
                                totalAmount: total.value,
                                items: cartItems.value.map(i => ({ id: i.id, type: i.type || 'product', price: i.price, quantity: i.quantity }))
                            };

                            const res = await fetch('/Order/Checkout', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            
                            const data = await res.json();
                            if (data.success) {
                                localStorage.removeItem('fastfood_cart');
                                cartItems.value = [];
                                window.showNotification("Đặt hàng thành công!", "success");
                                setTimeout(() => window.location.href = currentUser.isAuthenticated ? '/Account/History' : '/', 2000);
                            } else {
                                window.showNotification(data.message, "error");
                            }
                        } catch(e) {
                            window.showNotification("Lỗi kết nối", "error");
                        } finally {
                            isLoading.value = false;
                        }
                    };

                    return { cartItems, isLoading, checkoutForm, currentUser, total, updateQty, removeItem, formatPrice, checkout };
                }
            });
        }
    </script>
}
